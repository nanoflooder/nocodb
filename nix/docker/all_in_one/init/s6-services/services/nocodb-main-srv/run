#!/bin/execlineb -P

# setup by ../../../env-processor
envfile /etc/s6-confs/nocodb.main.conf
envfile /run/nocodb.common.dynamic.env
envfile /run/nocodb.main.dynamic.env

foreground { mkdir -p /var/lib/nocodb }
foreground { chown nocodb:nocodb /tmp /var/lib/nocodb }
foreground {
	if {
		test -d /var/lib/nocodb/nc
	} chown -R nocodb:nocodb /var/lib/nocodb/nc
}
foreground {
	if {
		test -f /var/lib/nocodb/noco.db
	} chown nocodb:nocodb /var/lib/nocodb/noco.db
}

# create database if not exists
foreground {
	if -n {
		pipeline {
			psql -U postgres -tAc SELECT\ 1\ FROM\ pg_database\ WHERE\ datname\ =\ \'nocodb\'
		} grep -q 1
	} psql -U postgres -tAc CREATE\ DATABASE\ \"nocodb\"
}

fdmove -c 2 1

execline-cd  /var/lib/nocodb s6-setuidgid nocodb nocodb
